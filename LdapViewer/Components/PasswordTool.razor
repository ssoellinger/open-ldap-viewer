@inject IStringLocalizer<Loc> L

<div class="password-tool">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <strong class="small">@L["Pwd_Title"]</strong>
        <button class="btn btn-sm btn-outline-secondary py-0 px-1" @onclick="Close"><i class="bi bi-x-lg"></i></button>
    </div>

    <div class="mb-2">
        <label class="form-label small mb-0">@L["Pwd_NewPassword"]</label>
        <div class="input-group input-group-sm">
            <input type="@(_showPassword ? "text" : "password")" class="form-control" @bind="_password" placeholder="@L["Pwd_Placeholder"]" />
            <button class="btn btn-outline-secondary" @onclick="() => _showPassword = !_showPassword" title="@(_showPassword ? L["Pwd_Hide"] : L["Pwd_Show"])">
                <i class="bi @(_showPassword ? "bi-eye-slash" : "bi-eye")"></i>
            </button>
            <button class="btn btn-outline-secondary" @onclick="GeneratePassword" title="@L["Pwd_GenerateTitle"]">
                <i class="bi bi-dice-5"></i>
            </button>
        </div>
    </div>

    <div class="mb-2">
        <label class="form-label small mb-0">@L["Pwd_HashAlgorithm"]</label>
        <select class="form-select form-select-sm" @bind="_hashAlgorithm">
            <option value="SSHA">SSHA (@L["Pwd_Recommended"])</option>
            <option value="SHA256">SHA-256</option>
            <option value="SHA512">SHA-512</option>
            <option value="SHA">SHA</option>
            <option value="MD5">MD5</option>
            <option value="CLEARTEXT">@L["Pwd_Cleartext"]</option>
        </select>
    </div>

    @if (!string.IsNullOrEmpty(_password))
    {
        <div class="mb-2">
            <label class="form-label small mb-0">@L["Pwd_Preview"]</label>
            <code class="d-block small text-break password-preview">@LdapService.HashPassword(_password, _hashAlgorithm)</code>
        </div>
    }

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="alert alert-danger small py-1 px-2">@_error</div>
    }
    @if (!string.IsNullOrEmpty(_success))
    {
        <div class="alert alert-success small py-1 px-2">@_success</div>
    }

    <button class="btn btn-sm btn-primary" @onclick="Apply" disabled="@(string.IsNullOrWhiteSpace(_password) || _saving)">
        @if (_saving)
        {
            <span class="spinner-border spinner-border-sm me-1"></span>
        }
        @L["Pwd_Set"]
    </button>
</div>

@code {
    [Parameter, EditorRequired]
    public string Dn { get; set; } = default!;

    [Parameter, EditorRequired]
    public LdapService LdapService { get; set; } = default!;

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback OnChanged { get; set; }

    private string _password = "";
    private string _hashAlgorithm = "SSHA";
    private bool _showPassword;
    private bool _saving;
    private string? _error;
    private string? _success;

    private void GeneratePassword()
    {
        const string chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*-_=+";
        var rng = System.Security.Cryptography.RandomNumberGenerator.Create();
        var buffer = new byte[16];
        rng.GetBytes(buffer);
        var sb = new System.Text.StringBuilder(16);
        foreach (var b in buffer)
        {
            sb.Append(chars[b % chars.Length]);
        }
        _password = sb.ToString();
        _showPassword = true;
    }

    private async Task Apply()
    {
        _error = null;
        _success = null;
        _saving = true;
        StateHasChanged();

        try
        {
            await LdapService.SetPassword(Dn, _password, _hashAlgorithm);
            _success = L["Pwd_SetSuccess"];
            _password = "";
            _showPassword = false;
            if (OnChanged.HasDelegate)
                await OnChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            _error = string.Format(L["Pwd_Error"], ex.Message);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task Close()
    {
        if (OnClose.HasDelegate)
            await OnClose.InvokeAsync();
    }
}
