@page "/ldif-import"
@inject ConnectionManager ConnMgr
@inject IJSRuntime JS
@inject IStringLocalizer<Loc> L
@rendermode InteractiveServer

<PageTitle>@L["PageTitle_LdifImport"]</PageTitle>

@if (_reconnecting)
{
    <div class="container mt-4 text-center">
        <span class="spinner-border me-2"></span> @L["Browser_Reconnecting"]
    </div>
}
else if (!ConnMgr.IsConnected)
{
    <div class="container mt-4">
        <div class="alert alert-warning">
            @L["Browser_NotConnected"] <a href="/">@L["Browser_ToConnectionPage"]</a>
        </div>
    </div>
}
else
{
    <div class="container-fluid mt-3 px-4">
        <h4 class="mb-3">@L["Ldif_Title"]</h4>

        <div class="mb-3">
            <label class="form-label">@L["Ldif_Content"]</label>
            <textarea class="form-control ldif-textarea" rows="12" @bind="_ldifContent" placeholder="dn: cn=New User,ou=People,dc=example,dc=com
objectClass: inetOrgPerson
objectClass: top
cn: New User
sn: User"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">@L["Ldif_Upload"]</label>
            <InputFile class="form-control form-control-sm" OnChange="HandleFileUpload" accept=".ldif,.ldf" />
        </div>

        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="alert alert-danger">@_error</div>
        }

        <div class="d-flex gap-2 mb-3">
            <button class="btn btn-primary" @onclick="ParseLdif" disabled="@(string.IsNullOrWhiteSpace(_ldifContent))">
                <i class="bi bi-code-slash me-1"></i>@L["Ldif_Parse"]
            </button>
            @if (_operations != null && _operations.Count > 0 && _results == null)
            {
                <button class="btn btn-success" @onclick="ExecuteLdif" disabled="@_executing">
                    @if (_executing)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-play-fill me-1"></i>@string.Format(L["Ldif_Execute"], _operations.Count)
                </button>
            }
            @if (_operations != null || _results != null)
            {
                <button class="btn btn-outline-secondary" @onclick="Reset"><i class="bi bi-arrow-counterclockwise me-1"></i>@L["Ldif_Reset"]</button>
            }
        </div>

        @if (_operations != null && _operations.Count > 0 && _results == null)
        {
            <h5>@L["Ldif_Preview"]</h5>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>@L["Ldif_DN"]</th>
                        <th style="width: 120px">@L["Ldif_Operation"]</th>
                        <th style="width: 80px">@L["Ldif_Attributes"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var op in _operations)
                    {
                        <tr>
                            <td class="font-monospace small">@op.Dn</td>
                            <td>
                                <span class="badge @GetOperationBadgeClass(op.ChangeType)">@op.ChangeType</span>
                            </td>
                            <td>
                                @if (op.ChangeType == LdifChangeType.Add)
                                {
                                    @op.Attributes.Count
                                }
                                else if (op.ChangeType == LdifChangeType.Modify)
                                {
                                    @op.Modifications.Count
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (_results != null)
        {
            <h5>@L["Ldif_Results"]</h5>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>@L["Ldif_DN"]</th>
                        <th style="width: 120px">@L["Ldif_Operation"]</th>
                        <th style="width: 100px">@L["Ldif_Status"]</th>
                        <th>@L["Ldif_Error"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var result in _results)
                    {
                        <tr class="@(result.Success ? "" : "table-danger")">
                            <td class="font-monospace small">@result.Dn</td>
                            <td>
                                <span class="badge @GetOperationBadgeClass(result.ChangeType)">@result.ChangeType</span>
                            </td>
                            <td>
                                @if (result.Success)
                                {
                                    <span class="badge bg-success">@L["Ldif_Success"]</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">@L["Ldif_Error"]</span>
                                }
                            </td>
                            <td class="small text-danger">@result.Error</td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="small text-muted">
                @string.Format(L["Ldif_SuccessCount"], _results.Count(r => r.Success), _results.Count)
            </div>
        }
    </div>
}

@code {
    private string _ldifContent = "";
    private List<LdifOperation>? _operations;
    private List<LdifResult>? _results;
    private string? _error;
    private bool _executing;
    private bool _reconnecting;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !ConnMgr.IsConnected)
        {
            _reconnecting = true;
            StateHasChanged();
            await ConnMgr.TryReconnectFromStorage(JS);
            _reconnecting = false;
            StateHasChanged();
        }
    }

    private void ParseLdif()
    {
        _error = null;
        _results = null;

        try
        {
            _operations = LdapService.ParseLdif(_ldifContent);
            if (_operations.Count == 0)
            {
                _error = L["Ldif_NoValidOps"];
            }
        }
        catch (Exception ex)
        {
            _error = string.Format(L["Ldif_ParseError"], ex.Message);
            _operations = null;
        }
    }

    private async Task ExecuteLdif()
    {
        if (_operations == null || _operations.Count == 0) return;

        _executing = true;
        _error = null;
        StateHasChanged();

        try
        {
            _results = await ConnMgr.Active!.ApplyLdif(_operations);
        }
        catch (Exception ex)
        {
            _error = string.Format(L["Ldif_GeneralError"], ex.Message);
        }
        finally
        {
            _executing = false;
        }
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            using var reader = new System.IO.StreamReader(e.File.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024));
            _ldifContent = await reader.ReadToEndAsync();
            _operations = null;
            _results = null;
            _error = null;
        }
        catch (Exception ex)
        {
            _error = string.Format(L["Ldif_FileError"], ex.Message);
        }
    }

    private void Reset()
    {
        _operations = null;
        _results = null;
        _error = null;
    }

    private static string GetOperationBadgeClass(LdifChangeType type) => type switch
    {
        LdifChangeType.Add => "bg-success",
        LdifChangeType.Modify => "bg-warning text-dark",
        LdifChangeType.Delete => "bg-danger",
        _ => "bg-secondary"
    };
}
