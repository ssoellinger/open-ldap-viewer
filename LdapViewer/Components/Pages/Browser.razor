@page "/browser"
@inject ConnectionManager ConnMgr
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IStringLocalizer<Loc> L
@rendermode InteractiveServer

<PageTitle>@L["PageTitle_Browser"]</PageTitle>

@if (_reconnecting)
{
    <div class="container mt-4 text-center">
        <span class="spinner-border me-2"></span> @L["Browser_Reconnecting"]
    </div>
}
else if (!ConnMgr.IsConnected)
{
    <div class="container mt-4">
        <div class="alert alert-warning">
            @L["Browser_NotConnected"] <a href="/">@L["Browser_ToConnectionPage"]</a>
        </div>
    </div>
}
else
{
    <ConnectionTabs Connections="ConnMgr.GetAll()" OnSwitch="SwitchConnection" OnClose="CloseConnection" OnAddNew="AddNewConnection" />

    <div class="ldap-browser">
        <div class="ldap-tree-panel">
            <div class="panel-header">
                <strong>@L["Browser_DirectoryTree"]</strong>
                <button class="btn btn-sm btn-outline-secondary" @onclick="Disconnect" title="@L["Browser_Disconnect"]">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
            <div class="panel-toolbar d-flex gap-1">
                <button class="btn btn-sm btn-outline-success" @onclick="ShowCreateEntry" title="@L["Editor_NewEntry"]">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" @onclick="ExpandAll" disabled="@_expanding" title="@L["Browser_ExpandAll"]">
                    @if (_expanding)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-arrows-expand"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CollapseAll" title="@L["Browser_CollapseAll"]">
                    <i class="bi bi-arrows-collapse"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ExportSubtreeLdif" disabled="@_exporting" title="@L["Browser_ExportTreeLdif"]">
                    @if (_exporting)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                        <span><i class="bi bi-file-earmark-arrow-down"></i> LDIF</span>
                    }
                </button>
            </div>

            @if (_bookmarks.Count > 0)
            {
                <div class="bookmark-panel">
                    <div class="bookmark-header d-flex align-items-center justify-content-between px-2 py-1">
                        <small class="fw-bold">@L["Browser_Bookmarks"] (@_bookmarks.Count)</small>
                        <button class="btn btn-sm btn-link p-0" @onclick="() => _bookmarksExpanded = !_bookmarksExpanded">
                            @(_bookmarksExpanded ? "\u25BE" : "\u25B8")
                        </button>
                    </div>
                    @if (_bookmarksExpanded)
                    {
                        @foreach (var bm in _bookmarks)
                        {
                            <div class="bookmark-item @(bm == _selectedDn ? "active" : "")"
                                 @onclick="() => HandleTreeSelect(bm)">
                                <span class="bookmark-label" title="@bm">@LdapEntry.GetRdn(bm)</span>
                                <button class="btn btn-sm btn-link p-0 bookmark-remove" @onclick:stopPropagation="true"
                                        @onclick="() => ToggleBookmark(bm)"><i class="bi bi-x"></i></button>
                            </div>
                        }
                    }
                </div>
            }

            <div class="tree-content">
                @if (_rootEntries == null)
                {
                    <div class="p-3">
                        <span class="spinner-border spinner-border-sm me-2"></span> @L["Browser_Loading"]
                    </div>
                }
                else if (_rootEntries.Count == 0)
                {
                    <div class="p-3 text-muted">@L["Browser_NoEntries"]</div>
                }
                else
                {
                    @foreach (var entry in _rootEntries)
                    {
                        <LdapTree @key="@($"{entry.Dn}_{_treeVersion}")"
                                  @ref="_rootTreeRef"
                                  Entry="entry"
                                  LdapService="ConnMgr.Active!"
                                  SelectedDn="@_selectedDn"
                                  OnSelect="HandleTreeSelect"
                                  OnContextMenu="ShowContextMenu"
                                  AutoExpand="true" />
                    }
                }
            </div>
        </div>
        <div class="ldap-detail-panel">
            <SearchPanel LdapService="ConnMgr.Active!"
                         BaseDn="@ConnMgr.Settings!.BaseDn"
                         HasResults="@(_searchResults != null)"
                         Error="@_searchError"
                         OnResults="HandleSearchResults"
                         OnError="HandleSearchError"
                         OnClear="HandleSearchClear" />

            @if (_showCreateEntry)
            {
                <LdapEntryEditor LdapService="ConnMgr.Active!"
                                 ParentDn="@(_selectedDn ?? ConnMgr.Settings!.BaseDn)"
                                 CopyFrom="@_copySource"
                                 OnCreated="HandleEntryCreated"
                                 OnCancel="CancelCreateEntry" />
            }
            else if (_searchResults != null)
            {
                <div class="search-results-panel">
                    <div class="search-results-list">
                        <div class="small text-muted p-2">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>@string.Format(L["Browser_ResultCount"], _searchResults.Count)</span>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="ExportSearchLdif" title="@L["Detail_ExportLdif"]"><i class="bi bi-file-earmark-arrow-down"></i> LDIF</button>
                            </div>
                            @if (_bulkSelected.Count > 0)
                            {
                                <div class="d-flex gap-1 align-items-center">
                                    <span class="small fw-bold">@string.Format(L["Browser_Selected"], _bulkSelected.Count)</span>
                                    <button class="btn btn-sm btn-outline-danger py-0 px-1" @onclick="BulkDelete" disabled="@_bulkDeleting" title="@L["Browser_DeleteSelected"]">
                                        @if (_bulkDeleting)
                                        {
                                            <span class="spinner-border spinner-border-sm"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-trash3"></i>
                                        }
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1" @onclick="() => _bulkSelected.Clear()" title="@L["Browser_None"]"><i class="bi bi-x-lg"></i></button>
                                </div>
                            }
                        </div>
                        @foreach (var result in _searchResults)
                        {
                            var resultDn = result.Dn;
                            <div class="search-result-item @(result.Dn == _selectedDn ? "active" : "")">
                                <div class="d-flex align-items-start gap-1">
                                    <input type="checkbox" class="form-check-input mt-1 flex-shrink-0"
                                           checked="@_bulkSelected.Contains(resultDn)"
                                           @onchange="() => ToggleBulkSelect(resultDn)" />
                                    <div class="flex-grow-1" @onclick="() => SelectSearchResult(resultDn)" style="cursor: pointer;">
                                        <div class="small fw-bold">@result.DisplayName</div>
                                        <div class="search-result-dn">@result.Dn</div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="search-detail">
                        @if (_selectedEntry != null)
                        {
                            <LdapEntryDetail Entry="_selectedEntry"
                                             LdapService="ConnMgr.Active!"
                                             OnBookmark="ToggleBookmark"
                                             IsBookmarked="@_bookmarks.Contains(_selectedEntry.Dn)"
                                             OnNavigate="HandleTreeSelect"
                                             OnDeleted="HandleEntryDeleted"
                                             OnModified="HandleEntryModified"
                                             OnCopy="HandleCopyEntry"
                                             OnMoved="HandleEntryMoved" />
                        }
                        else
                        {
                            <div class="p-3 text-muted">@L["Browser_ClickResult"]</div>
                        }
                    </div>
                </div>
            }
            else if (_selectedEntry != null)
            {
                <LdapEntryDetail Entry="_selectedEntry"
                                 LdapService="ConnMgr.Active!"
                                 OnBookmark="ToggleBookmark"
                                 IsBookmarked="@_bookmarks.Contains(_selectedEntry.Dn)"
                                 OnNavigate="HandleTreeSelect"
                                 OnDeleted="HandleEntryDeleted"
                                 OnModified="HandleEntryModified"
                                 OnCopy="HandleCopyEntry"
                                 OnMoved="HandleEntryMoved" />
            }
            else
            {
                <div class="p-4 text-muted">
                    @L["Browser_SelectEntry"]
                </div>
            }
        </div>
    </div>

    <TreeContextMenu MenuArgs="_contextMenu"
                     OnClose="CloseContextMenu"
                     OnNewChild="ContextMenuNewChild"
                     OnCopy="ContextMenuCopy"
                     OnCopyDn="ContextMenuCopyDn"
                     OnDelete="ContextMenuDelete" />
}

@code {
    private List<LdapEntry>? _rootEntries;
    private string? _selectedDn;
    private LdapEntry? _selectedEntry;
    private LdapTree? _rootTreeRef;
    private bool _expanding;
    private bool _reconnecting;
    private bool _exporting;
    private bool _showCreateEntry;
    private LdapEntry? _copySource;
    private int _treeVersion;

    // Search results (search execution is in SearchPanel)
    private List<LdapEntry>? _searchResults;
    private string? _searchError;

    // Bulk operations
    private HashSet<string> _bulkSelected = new();
    private bool _bulkDeleting;

    // Bookmarks
    private List<string> _bookmarks = new();
    private bool _bookmarksExpanded = true;

    // Context menu
    private TreeContextMenuArgs? _contextMenu;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadBookmarks();

            if (!ConnMgr.IsConnected)
            {
                await TryReconnect();
            }

            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (ConnMgr.IsConnected)
        {
            await LoadRootEntries();
        }
    }

    // Search callbacks
    private void HandleSearchResults(List<LdapEntry> results)
    {
        _searchResults = results;
        _searchError = null;
        _selectedEntry = null;
        _selectedDn = null;
        _showCreateEntry = false;
        _bulkSelected.Clear();
    }

    private void HandleSearchError(string error)
    {
        _searchError = error;
        _searchResults = null;
    }

    private void HandleSearchClear()
    {
        _searchResults = null;
        _searchError = null;
    }

    // Connection Tabs
    private async Task SwitchConnection(string id)
    {
        ConnMgr.SetActive(id);
        _selectedDn = null;
        _selectedEntry = null;
        _searchResults = null;
        _showCreateEntry = false;
        await LoadRootEntries();
        StateHasChanged();
    }

    private async Task CloseConnection(string id)
    {
        ConnMgr.RemoveConnection(id);

        if (!ConnMgr.IsConnected)
        {
            Navigation.NavigateTo("/");
            return;
        }

        _selectedDn = null;
        _selectedEntry = null;
        _searchResults = null;
        await LoadRootEntries();
        StateHasChanged();
    }

    private void AddNewConnection()
    {
        Navigation.NavigateTo("/");
    }

    // Create Entry
    private void ShowCreateEntry()
    {
        _showCreateEntry = true;
        _copySource = null;
        _searchResults = null;
    }

    private void CancelCreateEntry()
    {
        _showCreateEntry = false;
        _copySource = null;
    }

    private async Task HandleEntryCreated(string dn)
    {
        _showCreateEntry = false;
        _copySource = null;
        _treeVersion++;
        await LoadRootEntries();
        await HandleTreeSelect(dn);
    }

    private void HandleCopyEntry(LdapEntry entry)
    {
        _copySource = entry;
        _showCreateEntry = true;
        _searchResults = null;
    }

    // Bulk operations
    private void ToggleBulkSelect(string dn)
    {
        if (!_bulkSelected.Remove(dn))
            _bulkSelected.Add(dn);
    }

    private async Task BulkDelete()
    {
        if (_bulkSelected.Count == 0) return;

        _bulkDeleting = true;
        StateHasChanged();

        var errors = new List<string>();
        foreach (var dn in _bulkSelected.ToList())
        {
            try
            {
                await ConnMgr.Active!.DeleteEntry(dn);
                _searchResults?.RemoveAll(e => e.Dn == dn);
                _bulkSelected.Remove(dn);
            }
            catch (Exception ex)
            {
                errors.Add($"{dn}: {ex.Message}");
            }
        }

        _bulkDeleting = false;
        _treeVersion++;
        await LoadRootEntries();

        if (errors.Count > 0)
            _searchError = string.Format(L["Browser_BulkDeleteErrors"], errors.Count, errors[0]);

        if (_selectedDn != null && !(_searchResults?.Any(r => r.Dn == _selectedDn) ?? false))
        {
            _selectedDn = null;
            _selectedEntry = null;
        }

        StateHasChanged();
    }

    // Delete/Modify callbacks
    private async Task HandleEntryDeleted()
    {
        _selectedDn = null;
        _selectedEntry = null;
        _treeVersion++;
        await LoadRootEntries();
    }

    private Task HandleEntryModified(LdapEntry updatedEntry)
    {
        _selectedEntry = updatedEntry;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task HandleEntryMoved(string newDn)
    {
        _treeVersion++;
        await LoadRootEntries();
        await HandleTreeSelect(newDn);
    }

    // Bookmarks
    private async Task LoadBookmarks()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("bookmarkStorage.load");
            _bookmarks = JsonSerializer.Deserialize<List<string>>(json) ?? new();
        }
        catch
        {
            _bookmarks = new();
        }
    }

    private async Task SaveBookmarks()
    {
        var json = JsonSerializer.Serialize(_bookmarks);
        await JS.InvokeVoidAsync("bookmarkStorage.save", json);
    }

    private async Task ToggleBookmark(string dn)
    {
        if (_bookmarks.Contains(dn))
            _bookmarks.Remove(dn);
        else
            _bookmarks.Add(dn);

        await SaveBookmarks();
    }

    private async Task TryReconnect()
    {
        _reconnecting = true;
        StateHasChanged();

        if (await ConnMgr.TryReconnectFromStorage(JS))
        {
            await LoadRootEntries();
        }

        _reconnecting = false;
        StateHasChanged();
    }

    private async Task LoadRootEntries()
    {
        try
        {
            var baseDn = ConnMgr.Settings!.BaseDn;
            var baseEntry = await ConnMgr.Active!.GetEntry(baseDn);
            if (baseEntry != null)
            {
                _rootEntries = [baseEntry];
            }
            else
            {
                _rootEntries = [];
            }
        }
        catch (Exception ex)
        {
            _rootEntries = [];
            Console.Error.WriteLine(string.Format(L["Browser_LoadError"], ex.Message));
        }
    }

    private async Task HandleTreeSelect(string dn)
    {
        _selectedDn = dn;
        _searchResults = null;
        _searchError = null;
        _showCreateEntry = false;

        try
        {
            _selectedEntry = await ConnMgr.Active!.GetEntry(dn);
        }
        catch (Exception ex)
        {
            _selectedEntry = null;
            Console.Error.WriteLine(string.Format(L["Browser_LoadEntryError"], ex.Message));
        }
    }

    private async Task SelectSearchResult(string dn)
    {
        _selectedDn = dn;

        try
        {
            _selectedEntry = await ConnMgr.Active!.GetEntry(dn);
        }
        catch
        {
            _selectedEntry = null;
        }
    }

    private async Task ExpandAll()
    {
        if (_rootTreeRef == null) return;
        _expanding = true;
        StateHasChanged();

        try
        {
            await _rootTreeRef.ExpandAll();
        }
        finally
        {
            _expanding = false;
            StateHasChanged();
        }
    }

    private void CollapseAll()
    {
        _rootTreeRef?.CollapseAll();
    }

    private async Task ExportSubtreeLdif()
    {
        _exporting = true;
        StateHasChanged();

        try
        {
            var entries = await ConnMgr.Active!.GetSubtree(ConnMgr.Settings!.BaseDn);
            var ldif = LdapService.ToLdif(entries);
            await JS.InvokeVoidAsync("downloadFile", "export.ldif", ldif);
        }
        catch (Exception ex)
        {
            _searchError = string.Format(L["Browser_LdifExportError"], ex.Message);
        }
        finally
        {
            _exporting = false;
            StateHasChanged();
        }
    }

    private async Task ExportSearchLdif()
    {
        if (_searchResults == null || _searchResults.Count == 0) return;

        var ldif = LdapService.ToLdif(_searchResults);
        await JS.InvokeVoidAsync("downloadFile", "search-results.ldif", ldif);
    }

    private async Task Disconnect()
    {
        if (ConnMgr.ActiveId != null)
        {
            ConnMgr.RemoveConnection(ConnMgr.ActiveId);
        }
        await JS.InvokeVoidAsync("connectionStorage.clearLastConnection");
        Navigation.NavigateTo("/");
    }

    // Context Menu
    private void ShowContextMenu(TreeContextMenuArgs args)
    {
        _contextMenu = args;
        StateHasChanged();
    }

    private void CloseContextMenu()
    {
        _contextMenu = null;
    }

    private void ContextMenuNewChild()
    {
        if (_contextMenu == null) return;
        _showCreateEntry = true;
        _copySource = null;
        _searchResults = null;
        _selectedDn = _contextMenu.Dn;
        _contextMenu = null;
    }

    private async Task ContextMenuCopy()
    {
        if (_contextMenu == null) return;
        var dn = _contextMenu.Dn;
        _contextMenu = null;

        try
        {
            var entry = await ConnMgr.Active!.GetEntry(dn);
            if (entry != null)
                HandleCopyEntry(entry);
        }
        catch { }
    }

    private async Task ContextMenuCopyDn()
    {
        if (_contextMenu == null) return;
        await JS.InvokeVoidAsync("clipboardCopy", _contextMenu.Dn);
        _contextMenu = null;
    }

    private async Task ContextMenuDelete()
    {
        if (_contextMenu == null) return;
        var dn = _contextMenu.Dn;
        _contextMenu = null;

        try
        {
            await ConnMgr.Active!.DeleteEntry(dn);
            _treeVersion++;
            await LoadRootEntries();
            if (_selectedDn == dn)
            {
                _selectedDn = null;
                _selectedEntry = null;
            }
        }
        catch (Exception ex)
        {
            _searchError = string.Format(L["Browser_DeleteError"], ex.Message);
        }
    }
}
