@inject IJSRuntime JS
@inject IStringLocalizer<Loc> L

<div class="entry-detail">
    <div class="d-flex align-items-start justify-content-between mb-2">
        <DnBreadcrumb Dn="@Entry.Dn" OnNavigate="NavigateToDn" />
        <div class="d-flex gap-1 flex-shrink-0 ms-2 flex-wrap justify-content-end">
            @if (!_editMode)
            {
                <button class="btn btn-sm btn-outline-primary" @onclick="EnterEditMode" title="@L["Detail_Edit"]">
                    <i class="bi bi-pencil-square"></i>
                </button>
                @if (HasPasswordAttribute())
                {
                    <button class="btn btn-sm @(_showPasswordTool ? "btn-info" : "btn-outline-info")" @onclick="() => ToggleTool(ref _showPasswordTool)" title="@L["Detail_ChangePasswordTitle"]">
                        <i class="bi bi-key-fill"></i>
                    </button>
                }
                @if (IsGroupEntry())
                {
                    <button class="btn btn-sm @(_showGroupManager ? "btn-success" : "btn-outline-success")" @onclick="() => ToggleTool(ref _showGroupManager)" title="@L["Detail_ManageMembersTitle"]">
                        <i class="bi bi-people-fill"></i>
                    </button>
                }
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ToggleTool(ref _showMoveTool)" title="@L["Detail_MoveRenameTitle"]">
                    <i class="bi bi-arrows-move"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CopyDn" title="@L["Detail_CopyDn"]">
                    <i class="bi @(_copied == "dn" ? "bi-clipboard-check" : "bi-clipboard")"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ExportLdif" title="@L["Detail_ExportLdif"]">
                    <i class="bi bi-file-earmark-arrow-down"></i> LDIF
                </button>
                @if (OnCopy.HasDelegate)
                {
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => OnCopy.InvokeAsync(Entry)" title="@L["Detail_CopyAsTemplate"]">
                        <i class="bi bi-copy"></i>
                    </button>
                }
                @if (OnBookmark.HasDelegate)
                {
                    <button class="btn btn-sm @(IsBookmarked ? "btn-warning" : "btn-outline-warning")" @onclick="() => OnBookmark.InvokeAsync(Entry.Dn)" title="@(IsBookmarked ? L["Detail_BookmarkRemove"] : L["Detail_BookmarkSet"])">
                        <i class="bi @(IsBookmarked ? "bi-star-fill" : "bi-star")"></i>
                    </button>
                }
                @if (OnDeleted.HasDelegate)
                {
                    @if (_confirmDelete)
                    {
                        <button class="btn btn-sm btn-danger" @onclick="DeleteEntry">@L["Detail_ConfirmDelete"]</button>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => _confirmDelete = false"><i class="bi bi-x-lg"></i></button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => _confirmDelete = true" title="@L["Detail_DeleteEntry"]">
                            <i class="bi bi-trash3"></i>
                        </button>
                    }
                }
            }
            else
            {
                <button class="btn btn-sm btn-success" @onclick="SaveChanges" disabled="@_saving">
                    @if (_saving)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CancelEdit"><i class="bi bi-x-lg"></i></button>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="alert alert-danger alert-sm py-1 px-2 small">@_error</div>
    }

    @if (!string.IsNullOrEmpty(_success))
    {
        <div class="alert alert-success alert-sm py-1 px-2 small">@_success</div>
    }

    @* Password Tool *@
    @if (_showPasswordTool)
    {
        <div class="mb-3">
            <PasswordTool Dn="@Entry.Dn" LdapService="LdapService"
                          OnClose="() => _showPasswordTool = false"
                          OnChanged="HandleToolChanged" />
        </div>
    }

    @* Group Member Manager *@
    @if (_showGroupManager)
    {
        <div class="mb-3">
            <GroupMemberManager Entry="Entry" LdapService="LdapService"
                                OnClose="() => _showGroupManager = false"
                                OnChanged="HandleToolChanged"
                                OnNavigate="OnNavigate" />
        </div>
    }

    @* Move/Rename Tool *@
    @if (_showMoveTool)
    {
        <MoveRenameTool Entry="Entry" LdapService="LdapService"
                        OnClose="() => _showMoveTool = false"
                        OnMoved="HandleMoveCompleted" />
    }

    @if (Entry.Attributes.Count == 0)
    {
        <p class="text-muted">@L["Detail_NoAttributes"]</p>
    }
    else if (_editMode)
    {
        <table class="table table-sm table-striped edit-table">
            <thead>
                <tr>
                    <th style="width: 30%">@L["Detail_Attribute"]</th>
                    <th>@L["Detail_Values"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var attr in _editAttributes.OrderBy(a => a.Key))
                {
                    var attrName = attr.Key;
                    <tr>
                        <td class="attr-name">@attrName</td>
                        <td class="attr-value">
                            @for (int vi = 0; vi < attr.Value.Count; vi++)
                            {
                                var valueIdx = vi;
                                <div class="edit-value-row">
                                    <input type="text" class="form-control form-control-sm edit-input"
                                           value="@attr.Value[valueIdx]"
                                           @onchange="(e) => UpdateEditValue(attrName, valueIdx, e.Value?.ToString() ?? string.Empty)" />
                                    <button class="btn btn-sm btn-outline-danger edit-remove-btn" @onclick="() => RemoveEditValue(attrName, valueIdx)" title="@L["Detail_RemoveValue"]"><i class="bi bi-x"></i></button>
                                </div>
                            }
                            <button class="btn btn-sm btn-outline-secondary edit-add-value-btn" @onclick="() => AddEditValue(attrName)">@L["Detail_AddValue"]</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="edit-new-attribute">
            <div class="d-flex gap-1 align-items-end">
                <div>
                    <label class="form-label small mb-0">@L["Detail_NewAttribute"]</label>
                    <AttributeAutocomplete Value="@_newAttrName" ValueChanged="(v) => _newAttrName = v"
                                           ExtraSuggestions="@(_schemaAttributes)" Placeholder="@L["Autocomplete_Placeholder"]" />
                </div>
                <div class="flex-grow-1">
                    <label class="form-label small mb-0">@L["Detail_Value"]</label>
                    <input type="text" class="form-control form-control-sm" @bind="_newAttrValue" placeholder="@L["Detail_Value"]" />
                </div>
                <button class="btn btn-sm btn-outline-primary" @onclick="AddNewAttribute" disabled="@(string.IsNullOrWhiteSpace(_newAttrName))">@L["Detail_Add"]</button>
            </div>
        </div>
    }
    else
    {
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th style="width: 30%">@L["Detail_Attribute"]</th>
                    <th>@L["Detail_Values"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var attr in Entry.Attributes.OrderBy(a => a.Key))
                {
                    <tr>
                        <td class="attr-name">@attr.Key</td>
                        <td class="attr-value">
                            @if (attr.Value.Count == 1)
                            {
                                @if (IsMemberAttribute(attr.Key) && LooksLikeDn(attr.Value[0]))
                                {
                                    var memberDn = attr.Value[0];
                                    <span class="member-link" @onclick="() => NavigateToDn(memberDn)" title="@L["Detail_NavigateToEntry"]">@memberDn</span>
                                }
                                else
                                {
                                    @if (IsBinaryPlaceholder(attr.Value[0]))
                                    {
                                        <span class="text-muted small">@attr.Value[0]</span>
                                        @if (IsImageAttribute(attr.Key) || IsCertAttribute(attr.Key))
                                        {
                                            <BinaryPreview Dn="@Entry.Dn" AttributeName="@attr.Key" LdapService="LdapService"
                                                           IsImage="@IsImageAttribute(attr.Key)" IsCert="@IsCertAttribute(attr.Key)" />
                                        }
                                    }
                                    else
                                    {
                                        <span class="attr-value-text" @onclick="() => CopyValue(attr.Value[0])" title="@L["Detail_ClickToCopy"]">@attr.Value[0]</span>
                                        @if (_copied == $"{attr.Key}:0")
                                        {
                                            <span class="text-success small ms-1">@L["Detail_Copied"]</span>
                                        }
                                    }
                                }
                            }
                            else
                            {
                                <ul class="mb-0 ps-3">
                                    @{ var idx = 0; }
                                    @foreach (var val in attr.Value)
                                    {
                                        var copyKey = $"{attr.Key}:{idx}";
                                        var valCopy = val;
                                        <li>
                                            @if (IsMemberAttribute(attr.Key) && LooksLikeDn(valCopy))
                                            {
                                                <span class="member-link" @onclick="() => NavigateToDn(valCopy)" title="@L["Detail_NavigateToEntry"]">@valCopy</span>
                                            }
                                            else
                                            {
                                                <span class="attr-value-text" @onclick="() => CopyValue(valCopy, copyKey)" title="@L["Detail_ClickToCopy"]">@val</span>
                                                @if (_copied == copyKey)
                                                {
                                                    <span class="text-success small ms-1">@L["Detail_Copied"]</span>
                                                }
                                            }
                                        </li>
                                        idx++;
                                    }
                                </ul>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public LdapEntry Entry { get; set; } = default!;

    [Parameter, EditorRequired]
    public LdapService LdapService { get; set; } = default!;

    [Parameter]
    public EventCallback<string> OnBookmark { get; set; }

    [Parameter]
    public bool IsBookmarked { get; set; }

    [Parameter]
    public EventCallback<string> OnNavigate { get; set; }

    [Parameter]
    public EventCallback OnDeleted { get; set; }

    [Parameter]
    public EventCallback<LdapEntry> OnModified { get; set; }

    [Parameter]
    public EventCallback<LdapEntry> OnCopy { get; set; }

    [Parameter]
    public EventCallback<string> OnMoved { get; set; }

    private string? _copied;
    private bool _editMode;
    private bool _saving;
    private bool _confirmDelete;
    private string? _error;
    private string? _success;
    private string _newAttrName = "";
    private string _newAttrValue = "";

    // Edit state
    private Dictionary<string, List<string>> _editAttributes = new();
    private Dictionary<string, List<string>> _originalAttributes = new();
    private string[]? _schemaAttributes;

    // Tool panels
    private bool _showPasswordTool;
    private bool _showGroupManager;
    private bool _showMoveTool;

    private static readonly HashSet<string> MemberAttributes = new(StringComparer.OrdinalIgnoreCase)
    {
        "member", "uniqueMember", "memberUid", "owner", "seeAlso", "memberOf"
    };

    private static readonly HashSet<string> GroupObjectClasses = new(StringComparer.OrdinalIgnoreCase)
    {
        "groupOfNames", "groupOfUniqueNames", "posixGroup", "group"
    };

    private static bool IsMemberAttribute(string attrName) => MemberAttributes.Contains(attrName);
    private static bool LooksLikeDn(string value) => value.Contains('=') && value.Contains(',');
    private static bool IsBinaryPlaceholder(string value) => value.StartsWith("[Binary:");

    private static bool IsImageAttribute(string name) =>
        name.Equals("jpegPhoto", StringComparison.OrdinalIgnoreCase) ||
        name.Equals("photo", StringComparison.OrdinalIgnoreCase) ||
        name.Equals("thumbnailPhoto", StringComparison.OrdinalIgnoreCase);

    private static bool IsCertAttribute(string name) =>
        name.Equals("userCertificate", StringComparison.OrdinalIgnoreCase) ||
        name.Equals("userCertificate;binary", StringComparison.OrdinalIgnoreCase) ||
        name.Equals("cACertificate", StringComparison.OrdinalIgnoreCase) ||
        name.Equals("userSMIMECertificate", StringComparison.OrdinalIgnoreCase);

    private bool HasPasswordAttribute()
    {
        return Entry.Attributes.Any(a =>
            a.Key.Equals("userPassword", StringComparison.OrdinalIgnoreCase) ||
            a.Key.Equals("objectClass", StringComparison.OrdinalIgnoreCase) &&
            a.Value.Any(v => v.Equals("inetOrgPerson", StringComparison.OrdinalIgnoreCase) ||
                             v.Equals("person", StringComparison.OrdinalIgnoreCase) ||
                             v.Equals("posixAccount", StringComparison.OrdinalIgnoreCase) ||
                             v.Equals("account", StringComparison.OrdinalIgnoreCase)));
    }

    private bool IsGroupEntry()
    {
        return Entry.Attributes
            .Where(a => a.Key.Equals("objectClass", StringComparison.OrdinalIgnoreCase))
            .SelectMany(a => a.Value)
            .Any(v => GroupObjectClasses.Contains(v));
    }

    private void ToggleTool(ref bool tool)
    {
        var newState = !tool;
        _showPasswordTool = false;
        _showGroupManager = false;
        _showMoveTool = false;
        tool = newState;
    }

    private async Task HandleMoveCompleted(string newDn)
    {
        _showMoveTool = false;
        if (OnMoved.HasDelegate)
            await OnMoved.InvokeAsync(newDn);
    }

    private async Task HandleToolChanged()
    {
        try
        {
            var updated = await LdapService.GetEntry(Entry.Dn);
            if (updated != null)
            {
                Entry = updated;
                if (OnModified.HasDelegate)
                    await OnModified.InvokeAsync(updated);
            }
        }
        catch { }
    }

    // Edit Mode
    private async Task EnterEditMode()
    {
        _editMode = true;
        _error = null;
        _success = null;
        _showPasswordTool = false;
        _showGroupManager = false;
        _showMoveTool = false;
        _editAttributes = Entry.Attributes.ToDictionary(a => a.Key, a => new List<string>(a.Value));
        _originalAttributes = Entry.Attributes.ToDictionary(a => a.Key, a => new List<string>(a.Value));

        try
        {
            var schema = await LdapService.GetSchema();
            var objectClasses = Entry.Attributes
                .Where(a => a.Key.Equals("objectClass", StringComparison.OrdinalIgnoreCase))
                .SelectMany(a => a.Value)
                .ToList();

            _schemaAttributes = objectClasses.Count > 0
                ? schema.GetAllowedAttributes(objectClasses).OrderBy(a => a, StringComparer.OrdinalIgnoreCase).ToArray()
                : schema.AttributeTypes.Select(a => a.Name).ToArray();
        }
        catch { _schemaAttributes = null; }
    }

    private void CancelEdit()
    {
        _editMode = false;
        _error = null;
        _success = null;
        _newAttrName = "";
        _newAttrValue = "";
    }

    private void UpdateEditValue(string attrName, int index, string newValue)
    {
        if (_editAttributes.TryGetValue(attrName, out var values) && index < values.Count)
            values[index] = newValue;
    }

    private void RemoveEditValue(string attrName, int index)
    {
        if (_editAttributes.TryGetValue(attrName, out var values) && index < values.Count)
        {
            values.RemoveAt(index);
            if (values.Count == 0)
                _editAttributes.Remove(attrName);
        }
    }

    private void AddEditValue(string attrName)
    {
        if (_editAttributes.TryGetValue(attrName, out var values))
            values.Add("");
    }

    private void AddNewAttribute()
    {
        if (string.IsNullOrWhiteSpace(_newAttrName)) return;
        var name = _newAttrName.Trim();
        var value = _newAttrValue.Trim();

        if (_editAttributes.ContainsKey(name))
            _editAttributes[name].Add(value);
        else
            _editAttributes[name] = new List<string> { value };

        _newAttrName = "";
        _newAttrValue = "";
    }

    private async Task SaveChanges()
    {
        _saving = true;
        _error = null;
        _success = null;
        StateHasChanged();

        try
        {
            var modifications = ComputeModifications();
            if (modifications.Count == 0)
            {
                _editMode = false;
                _saving = false;
                return;
            }

            await LdapService.ModifyEntry(Entry.Dn, modifications);
            var updated = await LdapService.GetEntry(Entry.Dn);
            if (updated != null)
            {
                Entry = updated;
                if (OnModified.HasDelegate)
                    await OnModified.InvokeAsync(updated);
            }

            _editMode = false;
            _success = L["Detail_ChangesSaved"];
        }
        catch (Exception ex)
        {
            _error = string.Format(L["Detail_SaveError"], ex.Message);
        }
        finally
        {
            _saving = false;
        }
    }

    private List<LdapModification> ComputeModifications()
    {
        var mods = new List<LdapModification>();

        foreach (var orig in _originalAttributes)
        {
            if (!_editAttributes.ContainsKey(orig.Key))
                mods.Add(new LdapModification { AttributeName = orig.Key, Type = LdapModificationType.Delete });
        }

        foreach (var edit in _editAttributes)
        {
            var values = edit.Value.Where(v => !string.IsNullOrEmpty(v)).ToList();
            if (values.Count == 0)
            {
                if (_originalAttributes.ContainsKey(edit.Key))
                    mods.Add(new LdapModification { AttributeName = edit.Key, Type = LdapModificationType.Delete });
                continue;
            }

            if (!_originalAttributes.TryGetValue(edit.Key, out var origValues))
            {
                foreach (var val in values)
                    mods.Add(new LdapModification { AttributeName = edit.Key, NewValue = val, Type = LdapModificationType.Add });
            }
            else if (!origValues.SequenceEqual(values))
            {
                foreach (var val in values)
                    mods.Add(new LdapModification { AttributeName = edit.Key, NewValue = val, Type = LdapModificationType.Replace });
            }
        }

        return mods;
    }

    // Delete
    private async Task DeleteEntry()
    {
        _error = null;
        try
        {
            await LdapService.DeleteEntry(Entry.Dn);
            _confirmDelete = false;
            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _error = string.Format(L["Detail_DeleteError"], ex.Message);
            _confirmDelete = false;
        }
    }

    // Navigation
    private async Task NavigateToDn(string dn)
    {
        if (OnNavigate.HasDelegate)
            await OnNavigate.InvokeAsync(dn);
    }

    private async Task CopyDn()
    {
        await JS.InvokeVoidAsync("clipboardCopy", Entry.Dn);
        _copied = "dn";
        StateHasChanged();
        await Task.Delay(1500);
        _copied = null;
    }

    private async Task CopyValue(string value, string? key = null)
    {
        await JS.InvokeVoidAsync("clipboardCopy", value);
        _copied = key ?? $"{value.GetHashCode()}";
        StateHasChanged();
        await Task.Delay(1500);
        _copied = null;
    }

    private async Task ExportLdif()
    {
        var ldif = LdapService.ToLdif(Entry);
        var filename = $"{Entry.DisplayName}.ldif";
        await JS.InvokeVoidAsync("downloadFile", filename, ldif);
    }
}
