@using LdapViewer.Models
@using LdapViewer.Services
@inject IJSRuntime JS

<div class="entry-detail">
    <div class="d-flex align-items-start justify-content-between mb-2">
        <div class="dn-breadcrumb mb-0">
            @{ var segments = ParseDnSegments(Entry.Dn); }
            @for (int i = 0; i < segments.Count; i++)
            {
                var segment = segments[i];
                var dn = BuildDnFromIndex(segments, i);
                @if (i > 0)
                {
                    <span class="dn-breadcrumb-separator">&gt;</span>
                }
                <span class="dn-breadcrumb-segment" @onclick="() => NavigateToDn(dn)" title="@dn">@segment</span>
            }
        </div>
        <div class="d-flex gap-1 flex-shrink-0 ms-2 flex-wrap justify-content-end">
            @if (!_editMode)
            {
                <button class="btn btn-sm btn-outline-primary" @onclick="EnterEditMode" title="Bearbeiten">
                    Bearbeiten
                </button>
                @if (HasPasswordAttribute())
                {
                    <button class="btn btn-sm @(_showPasswordTool ? "btn-info" : "btn-outline-info")" @onclick="() => ToggleTool(ref _showPasswordTool)" title="Passwort aendern">
                        Passwort
                    </button>
                }
                @if (IsGroupEntry())
                {
                    <button class="btn btn-sm @(_showGroupManager ? "btn-success" : "btn-outline-success")" @onclick="() => ToggleTool(ref _showGroupManager)" title="Mitglieder verwalten">
                        Mitglieder
                    </button>
                }
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ToggleTool(ref _showMoveTool)" title="Verschieben/Umbenennen">
                    Verschieben
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CopyDn" title="DN kopieren">
                    @(_copied == "dn" ? "Kopiert!" : "DN kopieren")
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ExportLdif" title="Als LDIF exportieren">
                    LDIF
                </button>
                @if (OnCopy.HasDelegate)
                {
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => OnCopy.InvokeAsync(Entry)" title="Eintrag als Vorlage kopieren">
                        Kopieren
                    </button>
                }
                @if (OnBookmark.HasDelegate)
                {
                    <button class="btn btn-sm @(IsBookmarked ? "btn-warning" : "btn-outline-warning")" @onclick="() => OnBookmark.InvokeAsync(Entry.Dn)" title="@(IsBookmarked ? "Lesezeichen entfernen" : "Lesezeichen setzen")">
                        @(IsBookmarked ? "\u2605" : "\u2606")
                    </button>
                }
                @if (OnDeleted.HasDelegate)
                {
                    @if (_confirmDelete)
                    {
                        <button class="btn btn-sm btn-danger" @onclick="DeleteEntry">Wirklich loeschen?</button>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => _confirmDelete = false">Abbrechen</button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => _confirmDelete = true" title="Eintrag loeschen">
                            Loeschen
                        </button>
                    }
                }
            }
            else
            {
                <button class="btn btn-sm btn-success" @onclick="SaveChanges" disabled="@_saving">
                    @if (_saving)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Speichern
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CancelEdit">Abbrechen</button>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="alert alert-danger alert-sm py-1 px-2 small">@_error</div>
    }

    @if (!string.IsNullOrEmpty(_success))
    {
        <div class="alert alert-success alert-sm py-1 px-2 small">@_success</div>
    }

    @* Password Tool *@
    @if (_showPasswordTool)
    {
        <div class="mb-3">
            <PasswordTool Dn="@Entry.Dn" LdapService="LdapService"
                          OnClose="() => _showPasswordTool = false"
                          OnChanged="HandleToolChanged" />
        </div>
    }

    @* Group Member Manager *@
    @if (_showGroupManager)
    {
        <div class="mb-3">
            <GroupMemberManager Entry="Entry" LdapService="LdapService"
                                OnClose="() => _showGroupManager = false"
                                OnChanged="HandleToolChanged"
                                OnNavigate="OnNavigate" />
        </div>
    }

    @* Move/Rename Tool *@
    @if (_showMoveTool)
    {
        <div class="tool-panel mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong class="small">Verschieben / Umbenennen</strong>
                <button class="btn btn-sm btn-outline-secondary py-0 px-1" @onclick="() => _showMoveTool = false">X</button>
            </div>
            <div class="mb-2">
                <label class="form-label small mb-0">Neuer RDN</label>
                <input type="text" class="form-control form-control-sm" @bind="_moveNewRdn" placeholder="@GetCurrentRdn()" />
            </div>
            <div class="mb-2">
                <label class="form-label small mb-0">Neuer Parent DN (leer = gleicher Ort)</label>
                <input type="text" class="form-control form-control-sm" @bind="_moveNewParent" placeholder="@GetCurrentParent()" />
            </div>
            @if (!string.IsNullOrEmpty(_moveError))
            {
                <div class="alert alert-danger small py-1 px-2">@_moveError</div>
            }
            <button class="btn btn-sm btn-primary" @onclick="ExecuteMove" disabled="@_moving">
                @if (_moving)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                }
                Verschieben
            </button>
        </div>
    }

    @if (Entry.Attributes.Count == 0)
    {
        <p class="text-muted">Keine Attribute vorhanden.</p>
    }
    else if (_editMode)
    {
        <table class="table table-sm table-striped edit-table">
            <thead>
                <tr>
                    <th style="width: 30%">Attribut</th>
                    <th>Wert(e)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var attr in _editAttributes.OrderBy(a => a.Key))
                {
                    var attrName = attr.Key;
                    <tr>
                        <td class="attr-name">@attrName</td>
                        <td class="attr-value">
                            @for (int vi = 0; vi < attr.Value.Count; vi++)
                            {
                                var valueIdx = vi;
                                <div class="edit-value-row">
                                    <input type="text" class="form-control form-control-sm edit-input"
                                           value="@attr.Value[valueIdx]"
                                           @onchange="(e) => UpdateEditValue(attrName, valueIdx, e.Value?.ToString() ?? string.Empty)" />
                                    <button class="btn btn-sm btn-outline-danger edit-remove-btn" @onclick="() => RemoveEditValue(attrName, valueIdx)" title="Wert entfernen">X</button>
                                </div>
                            }
                            <button class="btn btn-sm btn-outline-secondary edit-add-value-btn" @onclick="() => AddEditValue(attrName)">+ Wert</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="edit-new-attribute">
            <div class="d-flex gap-1 align-items-end">
                <div>
                    <label class="form-label small mb-0">Neues Attribut</label>
                    <AttributeAutocomplete Value="@_newAttrName" ValueChanged="(v) => _newAttrName = v"
                                           ExtraSuggestions="@(_schemaAttributes)" Placeholder="Attribut-Name" />
                </div>
                <div class="flex-grow-1">
                    <label class="form-label small mb-0">Wert</label>
                    <input type="text" class="form-control form-control-sm" @bind="_newAttrValue" placeholder="Wert" />
                </div>
                <button class="btn btn-sm btn-outline-primary" @onclick="AddNewAttribute" disabled="@(string.IsNullOrWhiteSpace(_newAttrName))">Hinzufuegen</button>
            </div>
        </div>
    }
    else
    {
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th style="width: 30%">Attribut</th>
                    <th>Wert(e)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var attr in Entry.Attributes.OrderBy(a => a.Key))
                {
                    <tr>
                        <td class="attr-name">@attr.Key</td>
                        <td class="attr-value">
                            @if (attr.Value.Count == 1)
                            {
                                @if (IsMemberAttribute(attr.Key) && LooksLikeDn(attr.Value[0]))
                                {
                                    var memberDn = attr.Value[0];
                                    <span class="member-link" @onclick="() => NavigateToDn(memberDn)" title="Zum Eintrag navigieren">@memberDn</span>
                                }
                                else
                                {
                                    <span class="attr-value-text" @onclick="() => CopyValue(attr.Value[0])" title="Klicken zum Kopieren">@attr.Value[0]</span>
                                    @if (_copied == $"{attr.Key}:0")
                                    {
                                        <span class="text-success small ms-1">Kopiert!</span>
                                    }
                                }
                            }
                            else
                            {
                                <ul class="mb-0 ps-3">
                                    @{ var idx = 0; }
                                    @foreach (var val in attr.Value)
                                    {
                                        var copyKey = $"{attr.Key}:{idx}";
                                        var valCopy = val;
                                        <li>
                                            @if (IsMemberAttribute(attr.Key) && LooksLikeDn(valCopy))
                                            {
                                                <span class="member-link" @onclick="() => NavigateToDn(valCopy)" title="Zum Eintrag navigieren">@valCopy</span>
                                            }
                                            else
                                            {
                                                <span class="attr-value-text" @onclick="() => CopyValue(valCopy, copyKey)" title="Klicken zum Kopieren">@val</span>
                                                @if (_copied == copyKey)
                                                {
                                                    <span class="text-success small ms-1">Kopiert!</span>
                                                }
                                            }
                                        </li>
                                        idx++;
                                    }
                                </ul>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public LdapEntry Entry { get; set; } = default!;

    [Parameter, EditorRequired]
    public LdapService LdapService { get; set; } = default!;

    [Parameter]
    public EventCallback<string> OnBookmark { get; set; }

    [Parameter]
    public bool IsBookmarked { get; set; }

    [Parameter]
    public EventCallback<string> OnNavigate { get; set; }

    [Parameter]
    public EventCallback OnDeleted { get; set; }

    [Parameter]
    public EventCallback<LdapEntry> OnModified { get; set; }

    [Parameter]
    public EventCallback<LdapEntry> OnCopy { get; set; }

    [Parameter]
    public EventCallback<string> OnMoved { get; set; }

    private string? _copied;
    private bool _editMode;
    private bool _saving;
    private bool _confirmDelete;
    private string? _error;
    private string? _success;
    private string _newAttrName = "";
    private string _newAttrValue = "";

    // Edit state
    private Dictionary<string, List<string>> _editAttributes = new();
    private Dictionary<string, List<string>> _originalAttributes = new();
    private string[]? _schemaAttributes;

    // Tool panels
    private bool _showPasswordTool;
    private bool _showGroupManager;
    private bool _showMoveTool;
    private string _moveNewRdn = "";
    private string _moveNewParent = "";
    private string? _moveError;
    private bool _moving;

    private static readonly HashSet<string> MemberAttributes = new(StringComparer.OrdinalIgnoreCase)
    {
        "member", "uniqueMember", "memberUid", "owner", "seeAlso", "memberOf"
    };

    private static readonly HashSet<string> GroupObjectClasses = new(StringComparer.OrdinalIgnoreCase)
    {
        "groupOfNames", "groupOfUniqueNames", "posixGroup", "group"
    };

    private static bool IsMemberAttribute(string attrName) => MemberAttributes.Contains(attrName);

    private static bool LooksLikeDn(string value) => value.Contains('=') && value.Contains(',');

    private bool HasPasswordAttribute()
    {
        return Entry.Attributes.Any(a =>
            a.Key.Equals("userPassword", StringComparison.OrdinalIgnoreCase) ||
            a.Key.Equals("objectClass", StringComparison.OrdinalIgnoreCase) &&
            a.Value.Any(v => v.Equals("inetOrgPerson", StringComparison.OrdinalIgnoreCase) ||
                             v.Equals("person", StringComparison.OrdinalIgnoreCase) ||
                             v.Equals("posixAccount", StringComparison.OrdinalIgnoreCase) ||
                             v.Equals("account", StringComparison.OrdinalIgnoreCase)));
    }

    private bool IsGroupEntry()
    {
        return Entry.Attributes
            .Where(a => a.Key.Equals("objectClass", StringComparison.OrdinalIgnoreCase))
            .SelectMany(a => a.Value)
            .Any(v => GroupObjectClasses.Contains(v));
    }

    private void ToggleTool(ref bool tool)
    {
        var newState = !tool;
        _showPasswordTool = false;
        _showGroupManager = false;
        _showMoveTool = false;
        tool = newState;
    }

    private string GetCurrentRdn()
    {
        var idx = Entry.Dn.IndexOf(',');
        return idx > 0 ? Entry.Dn[..idx] : Entry.Dn;
    }

    private string GetCurrentParent()
    {
        var idx = Entry.Dn.IndexOf(',');
        return idx > 0 ? Entry.Dn[(idx + 1)..] : "";
    }

    // Move/Rename
    private async Task ExecuteMove()
    {
        _moveError = null;
        var newRdn = string.IsNullOrWhiteSpace(_moveNewRdn) ? GetCurrentRdn() : _moveNewRdn.Trim();
        var newParent = string.IsNullOrWhiteSpace(_moveNewParent) ? null : _moveNewParent.Trim();

        // Nothing changed
        if (newRdn == GetCurrentRdn() && newParent == null)
        {
            _moveError = "Keine Aenderung angegeben.";
            return;
        }

        _moving = true;
        StateHasChanged();

        try
        {
            await LdapService.MoveEntry(Entry.Dn, newRdn, newParent);
            var newDn = newParent != null ? $"{newRdn},{newParent}" : $"{newRdn},{GetCurrentParent()}";
            _showMoveTool = false;
            _moveNewRdn = "";
            _moveNewParent = "";

            if (OnMoved.HasDelegate)
                await OnMoved.InvokeAsync(newDn);
        }
        catch (Exception ex)
        {
            _moveError = $"Fehler: {ex.Message}";
        }
        finally
        {
            _moving = false;
        }
    }

    private async Task HandleToolChanged()
    {
        // Reload entry after tool changes
        try
        {
            var updated = await LdapService.GetEntry(Entry.Dn);
            if (updated != null)
            {
                Entry = updated;
                if (OnModified.HasDelegate)
                    await OnModified.InvokeAsync(updated);
            }
        }
        catch { }
    }

    // Edit Mode
    private async Task EnterEditMode()
    {
        _editMode = true;
        _error = null;
        _success = null;
        _showPasswordTool = false;
        _showGroupManager = false;
        _showMoveTool = false;
        _editAttributes = Entry.Attributes.ToDictionary(
            a => a.Key,
            a => new List<string>(a.Value));
        _originalAttributes = Entry.Attributes.ToDictionary(
            a => a.Key,
            a => new List<string>(a.Value));

        try
        {
            var schema = await LdapService.GetSchema();
            var objectClasses = Entry.Attributes
                .Where(a => a.Key.Equals("objectClass", StringComparison.OrdinalIgnoreCase))
                .SelectMany(a => a.Value)
                .ToList();

            if (objectClasses.Count > 0)
            {
                var allowed = schema.GetAllowedAttributes(objectClasses);
                _schemaAttributes = allowed.OrderBy(a => a, StringComparer.OrdinalIgnoreCase).ToArray();
            }
            else
            {
                _schemaAttributes = schema.AttributeTypes.Select(a => a.Name).ToArray();
            }
        }
        catch
        {
            _schemaAttributes = null;
        }
    }

    private void CancelEdit()
    {
        _editMode = false;
        _error = null;
        _success = null;
        _newAttrName = "";
        _newAttrValue = "";
    }

    private void UpdateEditValue(string attrName, int index, string newValue)
    {
        if (_editAttributes.TryGetValue(attrName, out var values) && index < values.Count)
            values[index] = newValue;
    }

    private void RemoveEditValue(string attrName, int index)
    {
        if (_editAttributes.TryGetValue(attrName, out var values) && index < values.Count)
        {
            values.RemoveAt(index);
            if (values.Count == 0)
                _editAttributes.Remove(attrName);
        }
    }

    private void AddEditValue(string attrName)
    {
        if (_editAttributes.TryGetValue(attrName, out var values))
            values.Add("");
    }

    private void AddNewAttribute()
    {
        if (string.IsNullOrWhiteSpace(_newAttrName)) return;
        var name = _newAttrName.Trim();
        var value = _newAttrValue.Trim();

        if (_editAttributes.ContainsKey(name))
            _editAttributes[name].Add(value);
        else
            _editAttributes[name] = new List<string> { value };

        _newAttrName = "";
        _newAttrValue = "";
    }

    private async Task SaveChanges()
    {
        _saving = true;
        _error = null;
        _success = null;
        StateHasChanged();

        try
        {
            var modifications = ComputeModifications();
            if (modifications.Count == 0)
            {
                _editMode = false;
                _saving = false;
                return;
            }

            await LdapService.ModifyEntry(Entry.Dn, modifications);
            var updated = await LdapService.GetEntry(Entry.Dn);
            if (updated != null)
            {
                Entry = updated;
                if (OnModified.HasDelegate)
                    await OnModified.InvokeAsync(updated);
            }

            _editMode = false;
            _success = "Aenderungen gespeichert.";
        }
        catch (Exception ex)
        {
            _error = $"Fehler beim Speichern: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private List<LdapModification> ComputeModifications()
    {
        var mods = new List<LdapModification>();

        foreach (var orig in _originalAttributes)
        {
            if (!_editAttributes.ContainsKey(orig.Key))
                mods.Add(new LdapModification { AttributeName = orig.Key, Type = LdapModificationType.Delete });
        }

        foreach (var edit in _editAttributes)
        {
            var values = edit.Value.Where(v => !string.IsNullOrEmpty(v)).ToList();
            if (values.Count == 0)
            {
                if (_originalAttributes.ContainsKey(edit.Key))
                    mods.Add(new LdapModification { AttributeName = edit.Key, Type = LdapModificationType.Delete });
                continue;
            }

            if (!_originalAttributes.TryGetValue(edit.Key, out var origValues))
            {
                foreach (var val in values)
                    mods.Add(new LdapModification { AttributeName = edit.Key, NewValue = val, Type = LdapModificationType.Add });
            }
            else if (!origValues.SequenceEqual(values))
            {
                foreach (var val in values)
                    mods.Add(new LdapModification { AttributeName = edit.Key, NewValue = val, Type = LdapModificationType.Replace });
            }
        }

        return mods;
    }

    // Delete
    private async Task DeleteEntry()
    {
        _error = null;
        try
        {
            await LdapService.DeleteEntry(Entry.Dn);
            _confirmDelete = false;
            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _error = $"Fehler beim Loeschen: {ex.Message}";
            _confirmDelete = false;
        }
    }

    // Navigation
    private static List<string> ParseDnSegments(string dn)
    {
        var segments = new List<string>();
        var current = new System.Text.StringBuilder();
        bool escaped = false;

        foreach (var c in dn)
        {
            if (escaped) { current.Append(c); escaped = false; continue; }
            if (c == '\\') { current.Append(c); escaped = true; continue; }
            if (c == ',')
            {
                if (current.Length > 0) { segments.Add(current.ToString().Trim()); current.Clear(); }
                continue;
            }
            current.Append(c);
        }

        if (current.Length > 0) segments.Add(current.ToString().Trim());
        return segments;
    }

    private static string BuildDnFromIndex(List<string> segments, int startIndex) =>
        string.Join(",", segments.Skip(startIndex));

    private async Task NavigateToDn(string dn)
    {
        if (OnNavigate.HasDelegate)
            await OnNavigate.InvokeAsync(dn);
    }

    private async Task CopyDn()
    {
        await JS.InvokeVoidAsync("clipboardCopy", Entry.Dn);
        _copied = "dn";
        StateHasChanged();
        await Task.Delay(1500);
        _copied = null;
    }

    private async Task CopyValue(string value, string? key = null)
    {
        await JS.InvokeVoidAsync("clipboardCopy", value);
        _copied = key ?? $"{value.GetHashCode()}";
        StateHasChanged();
        await Task.Delay(1500);
        _copied = null;
    }

    private async Task ExportLdif()
    {
        var ldif = LdapService.ToLdif(Entry);
        var filename = $"{Entry.DisplayName}.ldif";
        await JS.InvokeVoidAsync("downloadFile", filename, ldif);
    }
}
